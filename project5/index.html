<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project 5</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 20px auto;
            text-align: left;
        }
        h1 {
            color: #530f0f;
            text-align: center;
            
        }
        h2 {
            color: #8e1600;
            text-align: center;
            margin-top: 20px;
        }
        h3 {
            color: #804141;
            margin: 20px 10px 10px 10px;
            text-align: center;
        }
        h4 {
            color: #664848;
            margin: 20px 10px 10px 10px;
        }
        h5 {
            color: #a26b6b;
            margin: 20px 10px 10px 10px;
        }
        p {
            margin: 20px 10px 10px 10px;
        }
        
        img {
            max-width: 600px;
            height: auto;
            margin: 20px 10px 10px 10px;

        }

        figure {
            text-align: center; /* centers both image and caption */
            margin: 20px 0;
        }
        figcaption {
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }
        .image-row {
            
            display: flex;         
            gap: 20px;             
            flex-wrap: wrap;       
            justify-content: center; 
        }
        .image-row figure {
            margin: 0;
            text-align: center;
            flex: 0 1 200px;       
        }
        .image-row img {
            width: 200px;
            height: auto;
            display: block;
            image-rendering: pixelated;
        }
        .image-column {
            display: flex;
            flex-direction: column; 
            gap: 20px;      
            align-items: center;
        }

        .image-column figure {
            margin: 0;
            text-align: center;
        }

        .image-column img {
            max-width: 90%;  
            height: auto;
            display: block;
        }
        figure.side-by-side {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        

    </style>
</head>




<body>




<h1>Project 5A: The Power of Diffusion Models</h1>
<h2>Part 0: Set Up</h2>
            <h3> Prompt Embeddings </h3>
            <figure class="side-by-side">  <img src="p5pt0/pembs.png" style="height:400px;" > <figcaption>After gaining access to the DeepFloyd IF diffusion model through Hugging Face, I generated prompt embeddings using the provided Hugging Face clusters. Here are some of the prompts I embedded. </figcaption> </figure>

            <h3> Model Outputs: <code>num_inference_steps = 20</code> </h3>
                <p>  Random seed used: <code> seed_everything(100) </code> </p>
                <div class="image-row"> <figure> <img src = "p5pt0/seed100/download.png">  <figcaption> Prompt: a sunflower wearing sunglasses </figcaption> </figure>
                                        <figure> <img src = "p5pt0/seed100/download-1.png">  <figcaption> Prompt: a beach with an umbrella </figcaption> </figure>
                                        <figure> <img src = "p5pt0/seed100/download-2.png">  <figcaption> Prompt: a volleyball team playing basketball </figcaption> </figure>  </div>

            <h3> Model Outputs: <code>num_inference_steps = 60</code> </h3>
                <p>  Random seed used: <code> seed_everything(100) </code> </p>
                <div class="image-row"> <figure> <img src = "p5pt0/seed100/stepsize 60/download.png">  <figcaption> Prompt: a sunflower wearing sunglasses </figcaption> </figure>
                                        <figure> <img src = "p5pt0/seed100/stepsize 60/download-1.png">  <figcaption> Prompt: a beach with an umbrella </figcaption> </figure>
                                       <figure> <img src = "p5pt0/seed100/stepsize 60/download-2.png">  <figcaption> Prompt: a volleyball team playing basketball </figcaption> </figure>  </div>

            <h3> Reflection </h3>
                <p> The "a sunflower wearing glasses" prompt at low <code> num_inference_steps </code> doesn't capture the image well. It often fails to generate the sunglasses, but is able to capture the sunfloweriness of the sunflower just fine. At higher <code>num_inference_steps</code>, however, it is able to do create the sunflower wearing sunglasses, and at a higher quality. </p>
                <p> The "a beach with an umbrella" prompt seems to do well with both higher and lower <code> num_inference_steps </code>. In both images, we are able to make out the beach through the presence of sand and water at the horizon, and a umbrella. Interestingly, both images resemble digitally drawn backdrops. Both are relatively high quality, and retrieve what the prompt is trying to achieve. </p>
                <p> The "a volleyball team playing basketball" prompt does worse than the other two, but is still passable as a realistic image if not observed closely. With a lower <code> num_inference_steps </code>, we see that the humans are more unnaturally placed, and there is no basketball to be seen, but there is an absense of a volleyball net and the girls don't really seem like they're playing volleyball, but are wearing volleyball uniforms. But with a higher <code> num_inference_steps </code>, we see a very low net, a basketball, and girls in volleyball attire/poses, but they don't seem to be playing basketball. Both images seem natural and seem to conform to the given prompt at a glance, but don't correspond to the prompt the same way the other prompts do. </p>


<h2>Part 1: Sampling Loops</h2>
    <h3>1.1 Implementing the Forward Process</h3>
            <h4> Goal: Implement <code> noisy_im = forward(im, t) </code> </h4>
                <p> This <code>forward</code> function implements a one forward diffusion step in a diffusion model, as it's useful in simulating progressively adding noise to a clean image over time. It takes a clean image tensor <code>im</code> of shape <code>(1, 3, 64, 64)</code> and a timestep <code>t</code>, then returns a noisy version of the clean image at that timestep. </p>
                <figure> <img src = "p5 pt1/pt1.1/formula.png" > </figure>
                <p> First, we sample <code>epsilon</code> from Gaussian N(0,1) noise (same shape as the image). Then, we get cumulative products of diffusion alphas at timestep <code>t</code>, <code>alpha_bar_t</code>, to determine how much of the original image should by incorporated. The clean image is scaled by <code>sqrt(alpha_bar_t)</code> and the noise is scaled by <code>sqrt(1 - alpha_bar_t)</code>, and their sum produces a noisy image <code>im_noisy</code>. </p>
            <h4> Implementation </h4> <figure> <img src = "p5 pt1/pt1.1/imp.png" > </figure>

            <h4> Campanile at Noise Levels <code>t = 250, 500, 750 </code> </h4>
                        <div class="image-row"> <figure> <img src = "p5 pt1/pt1.4/original.png">  <figcaption> Original (scaled) Berkeley Campanile </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/pt1.1/camp250.png">  <figcaption> Noisy Campanile at t=250 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/pt1.1/camp500.png">  <figcaption> Noisy Campanile at t=500 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/pt1.1/camp750.png">  <figcaption> Noisy Campanile at t=750 </figcaption> </figure>  </div>


    
    <h3>1.2 Classical Denoising</h3>
            <h4> Goal: Gaussian blur filtering to try to remove the noise using <code>torchvision.transforms.functional.gaussian_blur</code> with <code>kkernel_size = [7, 7]</code> and <code> sigma = 1</code>. </h4>
                        <div class="image-row"> <figure> <img src = "p5 pt1/pt1.1/camp250.png">  <figcaption> Noisy Campanile at t=250 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/pt1.1/camp500.png">  <figcaption> Noisy Campanile at t=500 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/pt1.1/camp750.png">  <figcaption> Noisy Campanile at t=750 </figcaption> </figure>  </div>
                        <div class="image-row"> <figure> <img src = "p5 pt1/1.2/kernelsize5/download.png">  <figcaption> Gaussian Blur Denoising at t=250 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/1.2/kernelsize7/download-1.png">  <figcaption> Gaussian Blur Denoising at t=500 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/1.2/kernelsize7/download-2.png">  <figcaption> Gaussian Blur Denoising at t=750 </figcaption> </figure>  </div>

    <h3>1.3 One-Step Denoising</h3>
            <p> Here, we aim to denoise using our model. First, we run the forward process on the image at the given timestep <code>t</code>, and then predict the noise using the pretrained denoiser. Now, we can generate the clean estimate by solving for <code>x_0</code> from the equation in Part 1.1. </p>
            <h4> Goal: Denoise Using the Denoiser in one step. </h4>
                        <div class="image-row"> <figure> <img src = "p5 pt1/pt1.1/camp250.png">  <figcaption> Noisy Campanile at t=250 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/pt1.1/camp500.png">  <figcaption> Noisy Campanile at t=500 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/pt1.1/camp750.png">  <figcaption> Noisy Campanile at t=750 </figcaption> </figure>  </div>
                        <div class="image-row"> <figure> <img src = "p5 pt1/1.3/y250/download-1.png">  <figcaption> Model Noise Estimate at t=250 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/1.3/y500/download-1.png">  <figcaption> Model Noise Estimate at t=500 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/1.3/y750/download-1.png">  <figcaption> Model Noise Estimate at t=750 </figcaption> </figure>  </div>     
                        <div class="image-row"> <figure> <img src = "p5 pt1/1.3/y250/download copy.png">    <figcaption> One-Step Denoised Campanile at t=250 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/1.3/y500/download-2.png">  <figcaption> One-Step Denoised Campanile at t=500 </figcaption> </figure>
                                                <figure> <img src = "p5 pt1/1.3/y750/download-2.png">  <figcaption> One-Step Denoised Campanile at t=750 </figcaption> </figure>  </div>                        

    <h3>1.4 Iterative Denoising </h3>
            <p> Instead of taking one step towards the clean estimate, we can take multiple steps toward the clean estimate of the given noisy image in iterative denoising. </p>
            <p> Essentially, we are trying to implement this function: </p>
            <h4>Create <code>strided_timesteps</code>: a list of monotonically decreasing timesteps, starting at 990, with a stride of 30, eventually reaching 0. </h4>                 <figure> <img src = "p5 pt1/pt1.4/strides.png" > </figure>
            <h4> Also initialize the timesteps using <code></code>stage_1.scheduler.set_timesteps(timesteps=strided_timesteps)</code> </h4>
            <h4>Complete the <code>iterative_denoise</code> function:</h4>         <p> Essentially, we are trying to implement this equation: </p>    <figure class="side-by-side">  <img src="p5 pt1/pt1.4/formula.png" style="height:100;" > <figcaption> • <code>x_t</code> is your image at timestep <code>t</code> <br> 
                                                                                                                                                                                             • <code>x_t'</code> (<code>t < t'</code>) is your noisy image at timestep <code>t'</code> (a less noisy image) <br>
                                                                                                                                                                                             • <code>alpha_bar_t</code> helps determine how much of the clean image we want to retain at time <code>t</code>
                                                                                                                                                                                             • <code>alpha_t</code> =  <code>alpha_bar_t</code> / <code>alpha_bar_t'</code> <br>
                                                                                                                                                                                             • <code>beta_t</code> =  <code>1 - alpha_t</code> <br>
                                                                                                                                                                                             • <code> x_0 </code> is our current estimate of the clean image <br>
                                                                                                                                                                                             • <code> v_sigma </code> is random noise predicted by DeepFloyd. </figcaption> </figure>
            <h4> Implementation </h4>                 <figure> <img src = "p5 pt1/pt1.4/imp.png" > </figure>


            <h4> Show the noisy Campanile every 5th loop of denoising (gradually becomes less noisy). </h4>
                            <div class="image-row">         <figure> <img src = "p5 pt1/pt1.4/t690.png">    <figcaption> Iterative Denoising, Noisy Campanile at t = 690 </figcaption> </figure>
                                                            <figure> <img src = "p5 pt1/pt1.4/t540.png">    <figcaption> Iterative Denoising, Noisy Campanile at t = 540 </figcaption> </figure>
                                                            <figure> <img src = "p5 pt1/pt1.4/t390.png">    <figcaption> Iterative Denoising, Noisy Campanile at t = 390 </figcaption> </figure>
                                                            <figure> <img src = "p5 pt1/pt1.4/t240.png">    <figcaption> Iterative Denoising, Noisy Campanile at t = 240 </figcaption> </figure>
                                                            <figure> <img src = "p5 pt1/pt1.4/t90.png">    <figcaption> Iterative Denoising, Noisy Campanile at t = 90 </figcaption> </figure> </div>
            
            <h4> Cross-Denoising-Method Comparisons </h4>
                            <div class="image-row">         <figure> <img src = "p5 pt1/pt1.4/original.png">    <figcaption> Original (scaled) Campanile </figcaption> </figure>
                                                            <figure> <img src = "p5 pt1/pt1.4/iterativedenoising.png">    <figcaption> Iterative Denoising: final clean image prediction  </figcaption> </figure>
                                                            <figure> <img src = "p5 pt1/pt1.4/onestep.png">    <figcaption> One Step Denoising: predicted clean image using a single denoising step (looks worse than iterative denoising)</figcaption> </figure>
                                                            <figure> <img src = "p5 pt1/pt1.4/guassianblur.png">    <figcaption> Gaussian-Filter Denoising: predicted clean image using gaussian blurring </figcaption> </figure>  </div>



















<h1>Project 5B: Flow Matching from Scratch</h1>











</body>




</html>

